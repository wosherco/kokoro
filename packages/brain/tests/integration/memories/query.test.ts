import { db } from "@kokoro/db/client";
import {
  calendarTable,
  integrationsAccountsTable,
  memoryEventTable,
  memoryTable,
  memoryTaskTable,
  tasklistsTable,
  userTable,
} from "@kokoro/db/schema";
import { GOOGLE_CALENDAR, LINEAR_INTEGRATION } from "@kokoro/validators/db";
import type { StartedPostgreSqlContainer } from "@testcontainers/postgresql";
import { afterAll, beforeAll, describe, expect, it, vi } from "vitest";
import { getMemories } from "../../../src/memories/query";
import { createDatabaseContainer } from "../__utils__/containers";
import {
  TEST_EMBEDDING_FIX_LANDING_TYPO_DESCRIPTION,
  TEST_EMBEDDING_FIX_LANDING_TYPO_TEXT,
  TEST_EMBEDDINGS,
} from "../__utils__/embeddings";

const userId = crypto.randomUUID();

vi.mock("@kokoro/db/env", async () => {
  const originalEnvModule = await vi.importActual<
    typeof import("@kokoro/db/env")
  >("@kokoro/db/env");

  return {
    // Preserve other exports from @kokoro/db/env (if any)
    ...originalEnvModule,
    // Override the 'env' export
    env: {
      // Preserve other properties of the original env object
      ...originalEnvModule.env,
      // Override POSTGRES_URL for the test
      POSTGRES_URL: "postgresql://postgres:password@localhost:5432/postgres",
    },
  };
});

describe("querying memories", () => {
  let databaseContainer: StartedPostgreSqlContainer | undefined;

  beforeAll(async () => {
    const postgresContainer = await createDatabaseContainer();
    databaseContainer = postgresContainer;

    // Insert user
    await db.insert(userTable).values({
      id: userId,
      email: "test@test.com",
      name: "Test User",
    });

    // Insert calendar integration
    const calendarIntegrationId = crypto.randomUUID();
    const calendarPlatformAccountId = crypto.randomUUID();
    await db.insert(integrationsAccountsTable).values({
      id: calendarIntegrationId,
      userId,
      integrationType: GOOGLE_CALENDAR,
      platformAccountId: calendarPlatformAccountId,
      email: "test@test.com",
      platformDisplayName: "Test Integration",
      platformData: {
        syncToken: "test",
        lastSynced: new Date().toISOString(),
      },
      accessToken: "test",
      refreshToken: "test",
      expiresAt: new Date(),
    });

    // Insert calendar to calendar integration
    const calendarId = crypto.randomUUID();
    const calendarPlatformId = crypto.randomUUID();
    await db.insert(calendarTable).values({
      id: calendarId,
      userId,
      source: GOOGLE_CALENDAR,
      integrationAccountId: calendarIntegrationId,
      summary: "Test Calendar",
      platformAccountId: calendarPlatformAccountId,
      platformCalendarId: calendarPlatformId,
      platformData: {
        primary: true,
        accessRole: "owner",
      },
      eventsSyncToken: "test",
    });

    // Insert calendar event memory
    const eventMemoryId = crypto.randomUUID();
    const eventMemoryEventId = crypto.randomUUID();
    const eventPlatformId = crypto.randomUUID();
    await db.insert(memoryTable).values({
      id: eventMemoryId,
      userId,
      source: "CALENDAR",
      content: "Dentist appointment",
      contentEmbedding: [
        -0.06650842, 0.021423653, -0.034474738, -0.0151417665, -0.16177753,
        -0.055608753, -0.045113284, 0.025685329, 0.015187136, 0.0050837887,
        -0.05733368, -0.04168272, -0.059183378, 0.04591207, -0.041174676,
        0.013384512, 0.025305381, -0.017960662, 0.057088483, 0.009326397,
        -0.008700406, 0.05269312, -0.024290837, -0.028421594, -0.017362868,
        0.063244015, -0.00916279, -0.083132766, 0.068817616, 0.06664006,
        0.0015190602, -0.015059734, 0.082522, -0.055128712, 0.06007443,
        0.020643344, -0.040282693, 0.028044226, 0.021342613, 0.019352898,
        -0.047488887, 0.023803493, -0.001628428, 0.0044489386, 0.020414086,
        -0.016859861, 0.03513812, -0.014985152, 0.0054206494, -0.039700184,
        0.0075887, -0.048090115, -0.015074614, -0.034309067, -0.079062514,
        0.06806256, 0.01082802, -0.05672844, -0.002541745, 0.069708765,
        -0.009207849, -0.011101944, -0.048728302, 0.14034697, -0.08202345,
        0.09041608, 0.026749687, -0.057147525, 0.03592717, -0.022741763,
        -0.05492207, -0.004178924, 0.07713298, 0.031179663, 0.058025155,
        -0.06800423, 0.1133794, 0.0072682067, 0.01743733, 0.023383465,
        -0.028566342, -0.016833158, 0.022710167, 0.03576176, 0.028492166,
        -0.029551461, -0.038535055, 0.016481666, -0.037419397, -0.055030853,
        0.049699374, 0.040195376, -0.050847992, 0.026212713, -0.0013083261,
        0.05031787, -0.0016957031, 0.06490846, 0.025510162, 0.15593281,
        -0.00016918269, 0.029626813, -0.074637845, 0.053888462, -0.022255084,
        -0.03916081, -0.10313272, -0.09071036, -0.007358809, -0.025074255,
        0.020993894, 0.015620694, 0.05719409, -0.030938873, -0.065029375,
        0.017125363, 0.0061015473, 0.01894048, 0.0326577, 0.0803597,
        -0.023499342, -0.0030764989, -0.04791586, -0.05245525, 0.03930853,
        -0.031555947, 0.06460385, -4.0638394e-33, 0.035124145, -0.046773244,
        0.0077510453, -0.07221288, 0.043017235, 0.046867985, -0.016470743,
        0.024973756, -0.019418787, -0.00650337, 0.038285535, -0.001263981,
        0.017540202, -0.072809644, -0.13825884, 0.08949177, -0.010169569,
        0.08880399, -0.062787704, 0.061517965, -0.060166094, -0.10108353,
        -0.05215925, 0.13497294, -0.014423624, 0.055760007, 0.014159353,
        -0.076351605, 0.08888522, 0.003079666, -0.07226775, 0.012073628,
        0.039038334, -0.045422614, 0.06557664, 0.051910408, 0.025517048,
        0.0027389147, -0.028999291, -0.061903976, 0.0368484, 0.059805237,
        -0.00517939, 0.017411487, 0.056184076, 0.005165714, 0.012729798,
        0.08397917, 0.06914494, 0.020623408, -0.050018553, -0.04493176,
        -0.059199646, 0.07778046, -0.051568743, 0.015643045, 0.05588566,
        -0.0022787359, 0.036383886, 0.020556638, 0.021166658, -0.008048534,
        -0.006050469, 0.015069496, -0.06926613, -0.08668634, -0.0270773,
        -0.05292049, 0.049895298, -0.03060543, -0.045167185, 0.058231443,
        -0.0431665, 0.0017123962, -0.077240966, 0.040789276, 0.107255705,
        0.06435526, -0.049757436, 0.02461327, 0.041409988, -0.0048758206,
        0.012749836, -0.014494647, 0.03574436, 0.027704373, -0.058343023,
        -0.033701077, 0.038920224, 0.010701966, -0.09905276, -0.031293433,
        0.015166077, 0.015080246, 0.021051403, 2.0544883e-33, 0.04195794,
        -0.03131931, -0.030169858, 0.03346103, 0.03559248, 0.019971494,
        -0.039819088, 0.003017345, 0.0020690034, 0.0020701026, 0.0009530109,
        0.1198358, 0.12322539, -0.061248604, -0.0039493307, 0.057169802,
        0.04501401, -0.01627484, -0.062366743, 0.063032895, -0.013684839,
        0.05966662, 0.021347951, -0.07686826, -0.068908244, 0.03387148,
        0.0062534763, -0.047033846, -0.06006327, -0.016983086, -0.078034654,
        -0.041458078, -0.08569277, 0.055738147, -0.049449194, 0.12469682,
        -0.006775708, -0.026154278, -0.076029785, 0.058895633, 0.02154523,
        -0.013400389, 0.0067387694, 0.07307744, 0.004108105, 0.050962,
        0.032305524, 0.008798848, -0.029803157, 0.020462278, -0.09869846,
        0.04431473, -0.040632814, 0.0699267, -0.019732561, 0.013614268,
        -0.041468523, -0.07003577, -0.00636209, 0.026401408, 0.030152978,
        -0.023587957, -0.0010919307, -0.0013779972, -0.037867058, -0.03156976,
        0.023484468, -0.011632199, 0.026860569, 0.08149811, -0.06439101,
        0.006265359, -0.0075296103, -0.039722193, 0.014398697, 0.0041510435,
        0.04285075, -0.10078572, -0.06493107, -0.04581927, -0.07757056,
        0.020471202, 0.020866642, 0.065769315, -0.07338259, -0.031102713,
        0.08573986, -0.030947424, 0.0010304024, 0.01056255, -0.011331654,
        0.096751034, 0.0009687871, -0.06447877, 0.07425402, -1.15360725e-8,
        -0.02426618, -0.0022476027, 0.002391358, -0.026954217, 0.026991528,
        -0.21754083, -0.06682626, 0.021113763, -0.039678454, 0.053579178,
        0.068512395, 0.024679178, -0.03209114, -0.022259697, 0.024083484,
        0.03137541, 0.04291126, -0.027076917, -0.053339556, -0.04628663,
        -0.11170944, -0.030300187, 0.08516425, 0.009255676, 0.039924778,
        -0.025034247, -0.016443301, 0.093534306, -0.011773629, 0.045184538,
        -0.05921621, 0.093439, 0.00091663847, -0.039819214, -0.0023826575,
        -0.093755655, -0.02673565, -0.0007542382, 0.012594485, -0.005466649,
        0.0010782934, -0.035111282, 0.0050104344, 0.07568477, -0.08006789,
        0.021545557, 0.08472442, 0.043376114, 0.052610338, 0.027874364,
        -0.03296393, -0.010125722, 0.04637041, -0.051404566, -0.013895759,
        0.075264215, 0.08708815, -0.05664632, 0.0067338166, 0.058727715,
        -0.054617114, 0.0047619236, -0.02544459, -0.042369813,
      ],
      description:
        "Dentist appointment to get out my wisdom teeth of below right corner",
      descriptionEmbedding: [
        -0.025537774, 0.07303564, -0.03781451, 0.046902444, -0.06361533,
        -0.022621967, -0.0476013, 0.027348675, 0.0105978325, -0.041862786,
        -0.049149588, 0.019289576, -0.007254376, 0.0059766388, -0.03464064,
        -0.01623067, 0.017211458, -0.030801218, 0.0632386, 0.008111886,
        -0.026065933, 0.051234655, -0.028517216, -0.0036414282, -0.059350196,
        0.05649883, -0.03336149, -0.0622719, 0.05684158, 0.08330109, 0.03646177,
        -0.048765894, 0.031716082, -0.07553745, 0.08086841, -0.018197427,
        -0.06196832, 0.017614562, 0.026843574, 0.033972267, -0.021210577,
        0.036696196, -0.01761513, 0.024875125, 0.051591903, 0.059569065,
        -0.06302602, -0.029266262, 0.045590263, 0.0020163793, 0.019064026,
        -0.011468549, -0.075898275, 0.07552792, -0.08385896, 0.050054543,
        -0.027597206, -0.029749308, 0.025788, 0.07661209, 0.043677367,
        -0.018047476, -0.009466158, 0.10640495, -0.13344401, 0.08222821,
        0.049895667, -0.0564191, -0.002537631, -0.060881358, -0.033644233,
        -0.044660896, 0.09372492, -0.068589196, 0.053432927, -0.07389017,
        0.11423072, -0.012131794, -0.050095703, 0.009849596, -0.046828557,
        0.065598026, 0.02020489, 0.026583267, -0.048743904, -0.07505297,
        -0.009276426, 0.042310134, 0.033618893, -0.010023288, 0.008199261,
        0.045645837, -0.037843257, 0.051819913, 0.07707932, -0.008830821,
        0.004209953, -0.02355001, -0.024276627, 0.046102945, 0.011641004,
        -0.0054305387, -0.063439414, -0.031147353, 0.053015668, 0.014703947,
        -0.09094534, -0.061884884, 0.0028428333, -0.020234672, 0.05779842,
        0.048578907, 0.10440368, 0.010425656, -0.0133645525, -0.030040221,
        0.020487376, 0.085424446, 0.034643993, 0.05457399, -0.032764003,
        0.014651422, -0.02205763, -0.015542023, 0.04937104, -0.009775407,
        0.002954061, -1.4760264e-33, 0.03150738, -0.016110474, -0.036693294,
        -0.05443026, 0.051299687, 0.0002631516, -0.047502823, -0.017003505,
        -0.008275632, 0.05297916, -0.005150355, -0.06339981, 0.031571057,
        -0.08437125, -0.09613046, 0.07200384, -0.022642195, 0.08215053,
        -0.105750084, 0.063063875, -0.04130474, -0.10753769, -0.066730514,
        0.061742596, -0.035484377, 0.10177019, -0.00006402631, -0.093587175,
        0.030359797, -0.015446307, -0.04452327, 0.00058530207, 0.11208413,
        -0.07673444, 0.054136027, 0.032857705, -0.017574405, -0.022528343,
        0.004007362, -0.039102614, -0.00021497381, 0.06870747, 0.010276962,
        0.029265337, 0.045896087, -0.013774268, 0.05115661, 0.091303125,
        0.0720917, -0.11994891, -0.094560996, -0.030692436, -0.02658601,
        0.029757483, -0.046644527, -0.013884293, 0.0361002, 0.060389083,
        0.07911731, 0.025650565, -0.014294179, 0.016605496, -0.019878063,
        -0.06274061, -0.0063439747, -0.13636611, -0.09225409, -0.003398545,
        -0.0071401116, -0.034853287, 0.0143636465, 0.088626735, -0.006645957,
        0.013703017, -0.071681865, 0.076763384, 0.0746016, 0.010626829,
        -0.011658158, -0.003123992, 0.01735002, 0.013422492, 0.0069114305,
        -0.03247533, 0.102602184, 0.0088448515, -0.053594176, -0.044928707,
        0.012414807, -0.007541756, -0.115841575, -0.020605553, -0.002400315,
        -0.055370145, -0.015273382, -2.8869064e-34, 0.0317204, -0.01388305,
        -0.004616799, -0.020437919, 0.06324841, 0.018513126, -0.033094797,
        0.107766874, -0.0046338225, 0.026488137, -0.06592708, 0.13014334,
        0.05914017, -0.068005055, 0.033846807, 0.052268483, 0.054055568,
        -0.0017268907, -0.10156284, 0.032515153, -0.008796095, 0.04554431,
        -0.014963379, -0.03390072, -0.06556811, 0.043077562, 0.03664553,
        0.03486751, -0.06318408, 0.0389153, -0.10971305, -0.067002304,
        -0.075593725, 0.037598953, -0.038455762, 0.08551509, -0.016898938,
        -0.08607709, -0.10033082, 0.02357561, 0.0049066558, 0.05577779,
        -0.019821698, 0.02029254, -0.015352245, 0.06493425, 0.041503645,
        0.011912942, -0.033474162, 0.02997868, -0.059691157, 0.036651816,
        -0.027062353, 0.04273829, -0.038019914, -0.047552872, -0.023405397,
        -0.07091921, -0.0016846019, -0.029378885, 0.037403096, 0.03443288,
        -0.014602723, 0.0074176495, 0.015190666, 0.03156022, 0.056651417,
        0.04018617, -0.053776793, -0.007993805, -0.0540613, 0.008982026,
        0.007882232, -0.09280308, 0.061008338, 0.04903048, 0.093214594,
        -0.09812733, -0.012027328, -0.05800665, -0.01532158, 0.0040153316,
        0.031274963, 0.00816279, 0.0061244597, -0.025000641, 0.01931179,
        -0.03474696, -0.037195012, 0.0024644143, -0.0036569135, 0.098508455,
        0.055326372, 0.0083581135, 0.08419063, -1.8393768e-8, -0.03321107,
        -0.0073413667, -0.04081086, 0.033936117, -0.03190821, -0.1492863,
        -0.09216155, 0.062260028, -0.0582393, -0.033062387, 0.025735818,
        -0.016873067, -0.015225333, -0.04056059, -0.025053162, 0.039043196,
        -0.028835304, -0.023355603, -0.011310666, -0.03759174, -0.08154654,
        -0.07253703, 0.07343322, -0.014258229, 0.009033082, 0.017858872,
        -0.01857458, 0.09821375, 0.028372427, 0.04364558, -0.046484217,
        0.065898694, 0.03435411, -0.01258498, 0.028034434, -0.040111765,
        -0.053334855, 0.03378003, 0.04709668, 0.008145829, -0.013346388,
        -0.017569067, 0.013013161, 0.114884466, -0.092483334, -0.0004968867,
        0.06833614, 0.08865072, 0.03423232, 0.024803909, 0.006072312,
        -0.05542352, 0.064413235, -0.020009153, -0.005184023, 0.02474179,
        0.04459183, -0.06590908, -0.046554603, 0.046402484, -0.10283576,
        0.0257154, -0.018993285, -0.03396113,
      ],
      createdAt: new Date(),
      lastUpdate: new Date(),
    });
    await db.insert(memoryEventTable).values({
      id: eventMemoryEventId,
      userId,
      memoryId: eventMemoryId,
      icalUid: "test",
      integrationAccountId: calendarIntegrationId,
      platformAccountId: calendarPlatformAccountId,
      platformCalendarId: calendarPlatformId,
      platformId: eventPlatformId,
      calendarId: calendarId,
      source: GOOGLE_CALENDAR,
      sequence: 1,

      startDate: new Date("2025-05-22T13:30:48.512Z"),
      endDate: new Date("2025-05-22T14:30:48.512Z"),
      eventType: "default",
      attendenceStatus: "tentative",
    });

    // Insert task integration
    const taskIntegrationId = crypto.randomUUID();
    const taskPlatformAccountId = crypto.randomUUID();
    await db.insert(integrationsAccountsTable).values({
      id: taskIntegrationId,
      userId,
      integrationType: LINEAR_INTEGRATION,
      platformAccountId: taskPlatformAccountId,
      email: "test@test.com",
      platformDisplayName: "Test Integration",
      platformData: {
        workspaceId: "test",
      },
      accessToken: "test",
      refreshToken: "test",
      expiresAt: new Date(),
    });

    // Insert tasklist
    const tasklistId = crypto.randomUUID();
    const tasklistPlatformId = crypto.randomUUID();
    await db.insert(tasklistsTable).values({
      id: tasklistId,
      userId,
      integrationAccountId: taskIntegrationId,
      platformAccountId: taskPlatformAccountId,
      platformTaskListId: tasklistPlatformId,
      source: LINEAR_INTEGRATION,
      name: "Test Tasklist",
    });

    // Insert calendar event memory
    const taskMemoryId = crypto.randomUUID();
    const taskMemoryTaskId = crypto.randomUUID();
    const taskPlatformId = crypto.randomUUID();
    await db.insert(memoryTable).values({
      id: taskMemoryId,
      userId,
      source: "TASK",
      content: TEST_EMBEDDING_FIX_LANDING_TYPO_TEXT,
      contentEmbedding: TEST_EMBEDDINGS[TEST_EMBEDDING_FIX_LANDING_TYPO_TEXT],
      description: TEST_EMBEDDING_FIX_LANDING_TYPO_DESCRIPTION,
      descriptionEmbedding:
        TEST_EMBEDDINGS[TEST_EMBEDDING_FIX_LANDING_TYPO_DESCRIPTION],
      createdAt: new Date(),
      lastUpdate: new Date(),
    });
    await db.insert(memoryTaskTable).values({
      id: taskMemoryTaskId,
      userId,
      memoryId: taskMemoryId,
      tasklistId: tasklistId,
      integrationAccountId: taskIntegrationId,
      platformAccountId: taskPlatformAccountId,
      platformTaskListId: tasklistPlatformId,
      platformTaskId: taskPlatformId,
      source: LINEAR_INTEGRATION,
      dueDate: new Date("2025-05-22T13:30:48.512Z"),
    });
  }, 120000);

  afterAll(async () => {
    await databaseContainer?.stop();
  });

  describe("getMemories", () => {
    it("get empty memories", async () => {
      const memories = await getMemories(userId, []);
      expect(memories.length).toBe(0);
    });
  });
});
